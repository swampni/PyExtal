<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Overview of ROI definition in pyextal &#8212; PyExtal 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <script src="_static/documentation_options.js?v=d45e8c67"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Coarse Refinement (Correlation based refinement)" href="CoarseRefine.html" />
    <link rel="prev" title="Input .dat File Configuration" href="configuration.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section class="tex2jax_ignore mathjax_ignore" id="overview-of-roi-definition-in-pyextal">
<h1>Overview of ROI definition in pyextal<a class="headerlink" href="#overview-of-roi-definition-in-pyextal" title="Link to this heading">¶</a></h1>
<p>To correctly connect the experimental pattern and the simulation pattern, a specific transformation must be established between them. In pyextal , an additional intermediate state—referred to as <strong>display</strong>—is introduced between the experimental pattern and the simulation pattern.</p>
<section id="experimental-pattern">
<h2>Experimental Pattern<a class="headerlink" href="#experimental-pattern" title="Link to this heading">¶</a></h2>
<section id="cbed-pattern">
<h3>CBED Pattern<a class="headerlink" href="#cbed-pattern" title="Link to this heading">¶</a></h3>
<p><img alt="An example of a cuprite CBED pattern" src="_images/CBED_example.jpg" /></p>
</section>
<section id="larbed-pattern">
<h3>LARBED Pattern<a class="headerlink" href="#larbed-pattern" title="Link to this heading">¶</a></h3>
<p><img alt="An example of a Si LARBED (000) disk pattern" src="_images/LARBED_example.jpg" /></p>
<p>As shown, CBED and LARBED patterns have very different structures. CBED patterns typically appear as a single image covering multiple disks, whereas LARBED patterns usually consist of multiple images, with each image representing one diffraction disk.</p>
<p>To sample these patterns properly, when the <code class="docutils literal notranslate"><span class="pre">dinfo</span></code> class is associated with a data set and assigned to an <code class="docutils literal notranslate"><span class="pre">roi</span></code> class during initialization, a corresponding interpolation function is created. For CBED patterns, only one function is created; for LARBED patterns, each diffraction disk is interpolated separately. In this context, the top-left corner is defined as the origin <code class="docutils literal notranslate"><span class="pre">[j,</span> <span class="pre">i]</span></code>, where <strong>j</strong> indicates the vertical direction (downward) and <strong>i</strong> indicates the horizontal direction (to the right) (row-major order).</p>
</section>
</section>
<section id="display">
<h2>Display<a class="headerlink" href="#display" title="Link to this heading">¶</a></h2>
<p>Display coordinates represent the space in which diffraction patterns are rotated based on the user’s rotation parameter. The rotation aligns the designated x-axis horizontally, pointing to the right. Most operations are performed in this coordinate system, and the region of interest (ROI) is defined here.</p>
<p>For <strong>CBED</strong>, two parameters must be defined:</p>
<ul class="simple">
<li><p><strong>dpSize</strong>: The size of the working space, specified as <code class="docutils literal notranslate"><span class="pre">[height_of_dp,</span> <span class="pre">width_of_dp]</span></code>. It should be large enough to contain all the disks of interest while excluding any excessive blank regions.</p></li>
<li><p><strong>dpCenter</strong>: The reference point corresponding to the center of the (000) disk. This is specified as <code class="docutils literal notranslate"><span class="pre">[j,</span> <span class="pre">i]</span></code> (with <strong>j</strong> for the vertical direction and <strong>i</strong> for the horizontal direction, using the top-left corner as the origin). This point is important for connecting to the simulation pattern.</p></li>
</ul>
<p>For <strong>LARBED</strong>, these parameters do not need to be set manually. The <code class="docutils literal notranslate"><span class="pre">dpCenter</span></code> is automatically set to the top-left corner of the pattern, and <code class="docutils literal notranslate"><span class="pre">dpSize</span></code> is simply the size of the pattern.</p>
<p>Once these two parameters are defined, you are ready to select the ROI. Using the function <code class="docutils literal notranslate"><span class="pre">roi.selectROI</span></code>, you need to provide three vectors and two lengths (as illustrated in the following figure). Since the ROI is a parallelogram, three points are required to define it. All vectors are specified in the <code class="docutils literal notranslate"><span class="pre">[j,</span> <span class="pre">i]</span></code> system, relative to <code class="docutils literal notranslate"><span class="pre">dpCenter</span></code>. The parameters <code class="docutils literal notranslate"><span class="pre">length_x</span></code> and <code class="docutils literal notranslate"><span class="pre">length_y</span></code> define the number of points to sample within the ROI for <strong>fine refinement</strong> (coarse refinement is not affected by this setting).</p>
<section id="how-to-select-roi">
<h3>How to Select ROI<a class="headerlink" href="#how-to-select-roi" title="Link to this heading">¶</a></h3>
<p><img alt="selectROI" src="_images/ROI_DEF.png" /></p>
</section>
</section>
<section id="simulation-pattern">
<h2>Simulation Pattern<a class="headerlink" href="#simulation-pattern" title="Link to this heading">¶</a></h2>
<p>The simulation pattern shares the same orientation as the display coordinate system. However, it is defined in the (K_t) coordinate system, where each pixel corresponds to the tangential tilt vector relative to the zone axis. Note that this coordinate system is no longer represented as <code class="docutils literal notranslate"><span class="pre">[j,</span> <span class="pre">i]</span></code>; instead, it is a right-handed system following the relation:</p>
<div class="math notranslate nohighlight">
\[zone \times x = y\]</div>
<p>Therefore, when transforming between display and simulation coordinates, an inversion of the sign for the vertical direction is required.</p>
</section>
<hr class="docutils" />
<section id="setting-tilt0">
<h2>Setting tilt0<a class="headerlink" href="#setting-tilt0" title="Link to this heading">¶</a></h2>
<p>tilt0 refers to the indicdent beam direction of set in .dat file. In some cases, the tilt of the incident beam can be determined accurately without using coarse refinement (for example, by using the intersection of the HOLZ line). In such instances, you may want to assign a specific tilt to a pixel in the experimental pattern. This can be achieved by using the function <code class="docutils literal notranslate"><span class="pre">roi.setTilt0</span></code>, which accepts <span class="math notranslate nohighlight">\(K_t\)</span> and the pixel coordinates as parameters.</p>
<p>Additionally, you can look up where a certain <span class="math notranslate nohighlight">\(K_t\)</span> value corresponds in display space (relative to <code class="docutils literal notranslate"><span class="pre">dpCenter</span></code>) using <code class="docutils literal notranslate"><span class="pre">roi.kt2pixel</span></code>. To convert from display to experimental coordinates, use <code class="docutils literal notranslate"><span class="pre">roi.pixel2exp</span></code>.</p>
</section>
<hr class="docutils" />
<section id="how-everything-is-connected">
<h2>How Everything Is Connected<a class="headerlink" href="#how-everything-is-connected" title="Link to this heading">¶</a></h2>
<p>After selecting the ROI, a grid in display space (relative to <code class="docutils literal notranslate"><span class="pre">dpCenter</span></code>) is generated based on the input parameters. This grid is then transformed and propagated to both the experimental and simulation coordinate systems.</p>
</section>
<section id="transformation-between-each-coordinates">
<h2>Transformation Between each coordinates<a class="headerlink" href="#transformation-between-each-coordinates" title="Link to this heading">¶</a></h2>
<section id="from-display-to-experiment-roi-updateexpgrid">
<h3>From Display to Experiment (<code class="docutils literal notranslate"><span class="pre">roi.updateExpGrid</span></code>)<a class="headerlink" href="#from-display-to-experiment-roi-updateexpgrid" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>Conversion of Origin:</strong> The grid is first converted back to a coordinate system with the origin at the top left corner (this step is skipped for LARBED).</p></li>
<li><p><strong>Rotation to Experimental Space:</strong> The grid is rotated back into the experimental space using <code class="docutils literal notranslate"><span class="pre">roi.transformDP</span></code>. This function not only rotates the grid but also applies a shift (via <code class="docutils literal notranslate"><span class="pre">roi.shift</span></code>) to align the experimental pattern with <code class="docutils literal notranslate"><span class="pre">dpCenter</span></code>.</p></li>
<li><p><strong>Propagation to Other Disks:</strong> The grid is then propagated to the other disks based on rotation and a geometric transformation. (For LARBED, this step is skipped; instead, different interpolation functions are sampled for each disk at the same position.)</p></li>
</ol>
</section>
<section id="from-experiment-to-display">
<h3>From Experiment to Display<a class="headerlink" href="#from-experiment-to-display" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">roi.inverse</span></code> to convert experimental coordinates to display coordinates, assuming the origin is at the top left corner.<br />
<strong>Note:</strong> The code was modified from <code class="docutils literal notranslate"><span class="pre">skimage.transform.rotate</span></code>, which uses the <code class="docutils literal notranslate"><span class="pre">[x,</span> <span class="pre">y]</span></code> coordinate order. Therefore, all coordinates need to be flipped accordingly.</p></li>
<li><p>Calculate the offset from <code class="docutils literal notranslate"><span class="pre">dpCenter</span></code>.</p></li>
</ol>
</section>
<section id="from-display-to-simulation-roi-updatesimgrid">
<h3>From Display to Simulation (<code class="docutils literal notranslate"><span class="pre">roi.updateSimGrid</span></code>)<a class="headerlink" href="#from-display-to-simulation-roi-updatesimgrid" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>Calculate (K_t) Vectors:</strong> Compute the (K_t) vectors for the x and y directions.</p></li>
<li><p><strong>Apply Grid Multiplication:</strong> Since the grid is defined relative to <code class="docutils literal notranslate"><span class="pre">dpCenter</span></code>, multiply it by the corresponding xtilt and ytilt vectors.<br />
<strong>Note:</strong> Be sure to account for the sign inversion.</p></li>
<li><p><strong>Add tilt0:</strong> Add <code class="docutils literal notranslate"><span class="pre">tilt0</span></code> (the tilt corresponding to <code class="docutils literal notranslate"><span class="pre">dpCenter</span></code>).</p></li>
</ol>
</section>
<section id="from-simulation-to-display-roi-kt2pixel">
<h3>From Simulation to Display (<code class="docutils literal notranslate"><span class="pre">roi.kt2pixel</span></code>)<a class="headerlink" href="#from-simulation-to-display-roi-kt2pixel" title="Link to this heading">¶</a></h3>
<ol class="arabic simple">
<li><p><strong>Subtract tilt0:</strong> Subtract <code class="docutils literal notranslate"><span class="pre">tilt0</span></code> from the (K_t) vector of interest to make it relative to <code class="docutils literal notranslate"><span class="pre">dpCenter</span></code>.</p></li>
<li><p><strong>Calculate (K_t) Vectors:</strong> Compute the (K_t) vectors for the x and y directions.</p></li>
<li><p><strong>Decompose the Vectors:</strong> Decompose the result into the number of xtilt and ytilt units.<br />
<strong>Note:</strong> Watch out for sign inversion; the returned value is <code class="docutils literal notranslate"><span class="pre">[-offset_y,</span> <span class="pre">offset_x]</span></code>.</p></li>
</ol>
<p>The corresponding equations are:</p>
<div class="math notranslate nohighlight">
\[offset_x = \frac{(K_t - tilt_0) \cdot xtilt}{|xtilt|^2}\]</div>
<div class="math notranslate nohighlight">
\[offset_y = \frac{(K_t - tilt_0) \cdot ytilt}{|ytilt|^2}\]</div>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">PyExtal</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Getting started with PyExtal</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="architecture.html">Package Architecture</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="architecture.html#bloch-wave-simulation-engine">Bloch Wave Simulation Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#interface-for-optimization-and-analysis">Interface for Optimization and Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#basic-workflow">Basic Workflow</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="architecture.html#detail-explaination-of-the-workflow">detail explaination of the workflow</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="architecture.html">Package Architecture</a><ul>
      <li>Previous: <a href="configuration.html" title="previous chapter">Input <code class="docutils literal notranslate"><span class="pre">.dat</span></code> File Configuration</a></li>
      <li>Next: <a href="CoarseRefine.html" title="next chapter">Coarse Refinement (Correlation based refinement)</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, HCN, RB, and JMZ.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/ROI.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>