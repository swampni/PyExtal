<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Coarse Refinement (Correlation based refinement) &#8212; PyExtal 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <script src="_static/documentation_options.js?v=d45e8c67"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Fine Refientment (Intensity based Refinement)" href="FineRefine.html" />
    <link rel="prev" title="Overview of ROI definition in pyextal" href="ROI.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section class="tex2jax_ignore mathjax_ignore" id="coarse-refinement-correlation-based-refinement">
<h1>Coarse Refinement (Correlation based refinement)<a class="headerlink" href="#coarse-refinement-correlation-based-refinement" title="Link to this heading">¶</a></h1>
<p>In order to reduce calculation time, some parameters can be optimized with correlation metric, especially for those parameters that are sensitive to feature positions (e.g. holz line, rocking curve spacing etc.). This is done by simulating intensity of a predefined range of tilt wider than experiment field of view in reciprocal space using given parameter. The simulation can be done with a grid coarser than experiment data to reduce computation time. Experiment data is then used as a template to find the tilt position with highest correlation coefficient. This identify the best incident beam direction. In pyExtal, we applied the <code class="docutils literal notranslate"><span class="pre">features.match_template</span></code> function in <a class="reference external" href="https://scikit-image.org/">scikit-image</a> library for the matching. This process is defined as the target function, which is feed into <code class="docutils literal notranslate"><span class="pre">scipy.optimize.minimize</span></code> function with <code class="docutils literal notranslate"><span class="pre">method='brent'</span></code> option for optimization. All the optimization is done in the <strong>display</strong> space as described in <a class="reference internal" href="#"><span class="xref myst">ROI</span></a></p>
<p>To perform the coarse refinement, you need to set up a <code class="docutils literal notranslate"><span class="pre">CoarseRefine</span></code> object with the following parameters:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyextal.optimize</span> <span class="kn">import</span> <span class="n">CoarseOptimize</span>
<span class="n">coarse</span> <span class="o">=</span> <span class="n">CoarseOptimize</span><span class="p">(</span><span class="n">datpath</span><span class="o">=</span><span class="s1">&#39;path/to/dat&#39;</span><span class="p">,</span> <span class="n">dinfo</span><span class="o">=</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="n">roi</span><span class="p">)</span>
</pre></div>
</div>
<section id="image-preprocessing">
<h2>image preprocessing<a class="headerlink" href="#image-preprocessing" title="Link to this heading">¶</a></h2>
<p>Sometimes it is also advisable to use some image filtering techniques to enhance the features of interest. We provided a argument that allows user to pass in any kind of image preprocessing function with following singature to enhance the features.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sim</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Preprocess the input image to enhance features for correlation matching. </span>
<span class="sd">    Simulation and experiment patterns may require different preprocessing techniques as the range of intensity is different. </span>
<span class="sd">    Normalizaltion might be needed for thresholding or filtering.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    - image: Input image as a numpy array.</span>
<span class="sd">    - sim: Boolean indicating if the image is a simulation pattern (default is False).</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">    - Preprocessed image as a numpy array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sim</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">some_simulation_preprocessing_function</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">some_experiment_preprocessing_function</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
<p>This provides great flexibility for users to apply their own image processing techniques. Some predefined preprocessing functions will be shipped with pyExtal in the future.</p>
</section>
<section id="geometry-refinement">
<h2>geometry refinement<a class="headerlink" href="#geometry-refinement" title="Link to this heading">¶</a></h2>
<p>Geometry parmeters inlcude the incident beam direction, step size, and sample thicknss. In pyExtal, step size and sample thickness can only be refined separately and simultaneously with sample thickness. This is due to the fact that both step size and thickness affect the features in the diffraction pattern, so doing them together will lead to convergence issues.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CoarseRefine.optimizeOrientationThickness</span></code>: This function optimizes the target function using thickness as input parameter.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CoarseRefine.optimizeOrientationGL</span></code>: This function optimizes the target function using step size (gl) as input parameter.</p></li>
</ul>
</section>
<section id="hv-calibration">
<h2>HV calibration<a class="headerlink" href="#hv-calibration" title="Link to this heading">¶</a></h2>
<p>In CBED/LARBED experiments, the accceleration voltage (HV) is a critical parameter that affects the diffraction pattern. Similar to geometry parameter, a target function taking hV as input can be optimized. The <code class="docutils literal notranslate"><span class="pre">CoarseRefine.optimizeHV</span></code> function is used to optimize the HV parameter.</p>
</section>
<section id="debye-waller-factor">
<h2>Debye-Waller factor<a class="headerlink" href="#debye-waller-factor" title="Link to this heading">¶</a></h2>
<p>Debye-Waller factor is a parameter that describes the thermal vibrations of atoms in the crystal lattice. It can be refined using the coarse refinement method. The <code class="docutils literal notranslate"><span class="pre">CoarseRefine.optimizeDWF</span></code> function is used to optimize the Debye-Waller factor. This function takes the target function and optimizes it with respect to the Debye-Waller factor.</p>
</section>
<section id="unit-cell-refinement">
<h2>unit cell refinement<a class="headerlink" href="#unit-cell-refinement" title="Link to this heading">¶</a></h2>
<p>Unit cell parameters can also be refined using the coarse refinement method. The <code class="docutils literal notranslate"><span class="pre">CoarseRefine.optimizeUnitCell</span></code> function is used to optimize the unit cell parameters. This function takes the target function and optimizes it with respect to the unit cell parameters. As we have 6 unit cell parameters, the optimization is done with respect to all 6 parameters simultaneously using <code class="docutils literal notranslate"><span class="pre">method='Nelder-Mead'</span></code> option in <code class="docutils literal notranslate"><span class="pre">scipy.optimize.minimize</span></code>.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">PyExtal</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Getting started with PyExtal</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="architecture.html">Package Architecture</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="architecture.html#bloch-wave-simulation-engine">Bloch Wave Simulation Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#interface-for-optimization-and-analysis">Interface for Optimization and Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html#basic-workflow">Basic Workflow</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="architecture.html#detail-explaination-of-the-workflow">detail explaination of the workflow</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  <li><a href="architecture.html">Package Architecture</a><ul>
      <li>Previous: <a href="ROI.html" title="previous chapter">Overview of ROI definition in pyextal</a></li>
      <li>Next: <a href="FineRefine.html" title="next chapter">Fine Refientment (Intensity based Refinement)</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, HCN, RB, and JMZ.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/CoarseRefine.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>